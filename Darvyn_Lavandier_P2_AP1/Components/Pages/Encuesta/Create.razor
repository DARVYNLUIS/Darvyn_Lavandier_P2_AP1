@page "/Encuesta/Create"
@using Darvyn_Lavandier_P2_AP1.Services
@using Darvyn_Lavandier_P2_AP1.Models
@inject EncuestaService encuestaService
@inject CiudadService ciudadService
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<PageTitle>Crear Encuesta</PageTitle>
<EditForm Model="Encuesta" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="container">
        <div class="card shadow-lg">
            <div class="card-header text-center">
                <h5 class="card-title">Crear Encuesta</h5>
            </div>

            <div class="card-body">
                @* EncuestaId *@
                <div class="mb-3">
                    <label class="form-label"><strong>EncuestaId</strong></label>
                    <InputNumber class="form-control" @bind-Value="Encuesta.EncuestaId" readonly></InputNumber>
                </div>

                @* Fecha *@
                <div class="mb-3">
                    <label class="form-label"><strong>Fecha</strong></label>
                    <InputDate class="form-control" @bind-Value="Encuesta.Fecha"></InputDate>
                </div>

                @* Asignatura *@
                <div class="mb-3">
                    <label class="form-label"><strong>Asignatura</strong></label>
                    <InputText class="form-control" @bind-Value="Encuesta.Asignatura" />
                </div>

                @* Detalles de la Encuesta *@
                <div class="border border-success p-3 mt-3">
                    <h5>Detalles</h5>
                    <div class="input-group mb-3">
                        @* InputSelect para Ciudad *@
                        <InputSelect class="form-control" @bind-Value="DetalleSeleccionado.CiudadId">
                            <option value="0" selected disabled>Seleccione Ciudad</option>
                            @foreach (var ciudad in ListaCiudades)
                            {
                                <option value="@ciudad.Id">@ciudad.Nombre</option>
                            }
                        </InputSelect>

                        @* InputNumber para Monto *@
                        <InputNumber class="form-control" @bind-Value="DetalleSeleccionado.Monto"></InputNumber>

                        @* Botón para Agregar detalle *@
                        <button type="button" class="btn btn-success" @onclick="AgregarDetalle">+ Agregar</button>
                    </div>

                    @* Tabla de detalles *@
                    <table class="table table-light">
                        <thead class="table table-striped">
                            <tr class="text-center">
                                <th>Ciudad</th>
                                <th>Monto</th>
                                <th>Remover</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var detalle in Encuesta.Detalles)
                            {
                                <tr>
                                    <td>@detalle.Ciudad.Nombre</td>
                                    <td>@detalle.Monto.ToString("N2")</td>
                                    <td>
                                        <button type="button" class="btn btn-danger bi bi-trash" @onclick="() => RemoverDetalle(detalle)"></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @* Calcular el Monto Total *@
                    <div class="mt-3 text-right">
                        <strong>Monto Total:</strong> $@MontoTotal.ToString("N2")
                    </div>
                </div>
            </div>

            @* Footer *@
            <div class="card-footer text-center mt-2">
                <a href="/Encuestas/Index" class="btn btn-secondary bi bi-arrow-left"> Volver</a>
                <button type="submit" class="btn btn-primary bi bi-floppy"> Guardar</button>
            </div>
        </div>
    </div>
</EditForm>

@code {
    public Encuesta Encuesta { get; set; } = new Encuesta();
    public EncuestaDetalle DetalleSeleccionado { get; set; } = new EncuestaDetalle();
    public List<Ciudad> ListaCiudades { get; set; } = new List<Ciudad>();

    public decimal MontoTotal => Encuesta.Detalles.Sum(d => d.Monto);

    protected override async Task OnInitializedAsync()
    {
        ListaCiudades = await ciudadService.Listar(c => true);
        Encuesta.Fecha = DateTime.Now;
    }

    public void AgregarDetalle()
    {
        if (DetalleSeleccionado.CiudadId > 0 && DetalleSeleccionado.Monto > 0)
        {
            var ciudadSeleccionada = ListaCiudades.FirstOrDefault(c => c.Id == DetalleSeleccionado.CiudadId);
            if (ciudadSeleccionada != null)
            {
                Encuesta.Detalles.Add(new EncuestaDetalle
                    {
                        CiudadId = DetalleSeleccionado.CiudadId,
                        Ciudad = ciudadSeleccionada,
                        Monto = DetalleSeleccionado.Monto
                    });
             
                DetalleSeleccionado = new EncuestaDetalle();
            }
        }
    }

    public void RemoverDetalle(EncuestaDetalle detalle)
    {
        Encuesta.Detalles.Remove(detalle);
    }

    public async Task Guardar()
    {
        var paso = await encuestaService.Guardar(Encuesta);
        if (paso)
        {
            navigationManager.NavigateTo("/Encuestas/Index");
        }
    }
}
