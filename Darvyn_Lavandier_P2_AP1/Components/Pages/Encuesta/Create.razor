@page "/Encuesta/Create"
@using Darvyn_Lavandier_P2_AP1.Services
@using Darvyn_Lavandier_P2_AP1.Models
@inject EncuestaServices encuestaService
@inject CiudadServices ciudadService
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<PageTitle>Crear Encuesta</PageTitle>

<EditForm Model="Encuesta" OnValidSubmit="Guardar">
    <DataAnnotationsValidator />

    <div class="container">
        <div class="card shadow-lg">
            <div class="card-header text-center">
                <h5 class="card-title">Crear Encuesta</h5>
            </div>

            <div class="card-body">
                <!-- EncuestaId -->
                <div class="mb-3">
                    <label class="form-label"><strong>EncuestasId</strong></label>
                    <InputNumber class="form-control" @bind-Value="Encuesta.EncuestasId" readonly />
                </div>

                <!-- Fecha -->
                <div class="mb-3">
                    <label class="form-label"><strong>Fecha</strong></label>
                    <InputDate class="form-control" @bind-Value="Encuesta.Fecha" />
                </div>

                <!-- Asignatura -->
                <div class="mb-3">
                    <label class="form-label"><strong>Asignatura</strong></label>
                    <InputText class="form-control" @bind-Value="Encuesta.Asignatura" />
                </div>

                <!-- Detalles de la Encuesta -->
                <div class="border border-success p-3 mt-3">
                    <h5>Detalles</h5>
                    <div class="input-group mb-3">
                        <!-- InputSelect para Ciudad -->
                        <InputSelect class="form-control" @bind-Value="DetalleSeleccionado.CiudadId">
                            <option value="0" selected disabled>Seleccione Ciudad</option>
                            @foreach (var ciudad in ListaCiudades ?? new List<Ciudad>())
                            {
                                <option value="@ciudad.CiudadesId">@ciudad.Nombre</option>
                            }
                        </InputSelect>

                        <!-- InputNumber para Monto -->
                        <InputNumber class="form-control" @bind-Value="DetalleSeleccionado.MontoEncuesta" />

                        <!-- Botón para Agregar detalle -->
                        <button type="button" class="btn btn-success" @onclick="AgregarDetalle">+ Agregar</button>
                    </div>

                    <!-- Tabla de detalles -->
                    <table class="table table-light">
                        <thead class="table-striped">
                            <tr class="text-center">
                                <th>Ciudad</th>
                                <th>Monto</th>
                                <th>Remover</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var detalle in Encuesta.EncuestaDetalles ?? new List<EncuestaDetalle>())
                            {
                                <tr>
                                    <td>@detalle.Ciudad.Nombre</td>
                                    <td>@detalle.MontoEncuesta.ToString("N2")</td>
                                    <td>
                                        <button type="button" class="btn btn-danger bi bi-trash" @onclick="() => RemoverDetalle(detalle)"></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <!-- Calcular el Monto Total -->
                    <div class="mt-3 text-right">
                        <strong>Monto Total:</strong> $@MontoTotal.ToString("N2")
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="card-footer text-center mt-2">
                <a href="/Encuestas/Index" class="btn btn-secondary bi bi-arrow-left"> Volver</a>
                <button type="submit" class="btn btn-primary bi bi-floppy"> Guardar</button>
            </div>
        </div>
    </div>
</EditForm>

@code {
    public Encuesta Encuesta { get; set; } = new Encuesta { EncuestaDetalles = new List<EncuestaDetalle>() };
    public EncuestaDetalle DetalleSeleccionado { get; set; } = new EncuestaDetalle();
    public List<Ciudad> ListaCiudades { get; set; } = new List<Ciudad>();

    public decimal MontoTotal => Encuesta.EncuestaDetalles?.Sum(d => d.MontoEncuesta) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        // Inicializar la lista de ciudades
        ListaCiudades = await ciudadService.Listar(c => true);
        Encuesta.Fecha = DateTime.Now;
    }

    // Agregar detalle a la encuesta
    public void AgregarDetalle()
    {
        if (DetalleSeleccionado.CiudadId > 0 && DetalleSeleccionado.MontoEncuesta > 0)
        {
            // Comprobar si la ciudad ya está agregada en los detalles
            if (Encuesta.EncuestaDetalles.Any(d => d.CiudadId == DetalleSeleccionado.CiudadId))
            {
                return; // No agregar si ya está en la lista de detalles
            }

            var ciudadSeleccionada = ListaCiudades.FirstOrDefault(c => c.CiudadesId == DetalleSeleccionado.CiudadId);
            if (ciudadSeleccionada != null)
            {
                // Agregar el nuevo detalle
                Encuesta.EncuestaDetalles.Add(new EncuestaDetalle
                    {
                        CiudadId = DetalleSeleccionado.CiudadId,
                        Ciudad = ciudadSeleccionada,
                        MontoEncuesta = DetalleSeleccionado.MontoEncuesta
                    });

                // Limpiar el detalle seleccionado
                DetalleSeleccionado = new EncuestaDetalle();
            }
        }
    }

    // Remover detalle de la encuesta
    public void RemoverDetalle(EncuestaDetalle detalle)
    {
        Encuesta.EncuestaDetalles.Remove(detalle);
    }

    // Guardar encuesta
    public async Task Guardar()
    {
        var paso = await encuestaService.Guardar(Encuesta);
        if (paso)
        {
            navigationManager.NavigateTo("/Encuestas/Index");
        }
    }
}
